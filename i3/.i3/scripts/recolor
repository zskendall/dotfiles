#!/bin/bash

argv="$#"
THEME=$1
shift
IMAGES=("$@")

# normal font color
normal=$(tput sgr0)

warn() {
  yellow=$(tput setaf 3)
  printf "%s\n" "${yellow}$@${normal}"
}

error() {
  red=$(tput setaf 1)
  printf "%s\n" "${red}$@${normal}"
}

# @arg1 the config without the theme
# @arg2 the available themes for the config
no_theme_error() {
  # printf "\n%s\n%s\n%s\n" "${red}No $1 configuration for theme $THEME." \
  error "" "No $1 configuration for theme $THEME." \
    "  Available themes are [${2//$'\n'/ }]" \
    "Leaving $1 configuration as-is."
}

refresh_display() {
  if (( ${#IMAGES[@]} < 1 )); then
    warn "No images for theme $THEME. Leaving background as-is."
  else
    local display="feh --bg-scale "
    [[ $THEME == "borealis" ]] && display="feh --bg-fill "
    for i in "${IMAGES[@]}"; do
      display+="'$i' "
    done
    eval $display
  fi
}

theme_polybar() {
  local current=`egrep -o "^background = .{([a-z]*)" ~/.config/polybar/config \
    | grep -v "colors" | cut -d'{' -f 2`
  local updated=`[ $(grep "$THEME\]" ~/.config/polybar/config) ] \
    && echo "$THEME" || echo "default"`
  if [[ "$updated" == *"default"* ]]; then
    local available=`awk "/COLORS/,/\[colors\]/" ~/.config/polybar/config | \
      egrep "\[[a-z]+\]" | sed 's/[][]//g' | sed 's/colors//'`
    warn "" "Unknown polybar theme $THEME." \
      "  Available themes are: [${available//$'\n'/ }]" \
      "Using default polybar colors."
  fi
  local nbeg=`grep -n "\[colors\]" ~/.config/polybar/config | awk -F':' '{print $1}'`
  local nend=`grep -n "FONTS" ~/.config/polybar/config | awk -F':' '{print $1}'`
  sed -ri "${nbeg},${nend}s/${current}\./${updated}\./g" ~/.config/polybar/config

  # read and parse focus_foreground for the icon styling
  local focus=`awk "/\[$THEME\]/,/\[colors\]/" ~/.config/polybar/config | \
    egrep -m 1 "^focus-foreground" | cut -d'#' -f2`
  sed -ri "s/F#[a-f0-9]{6}/F#$focus/g" ~/.config/polybar/config
  sed -ri "s/F#[a-f0-9]{6}/F#$focus/" ~/.config/polybar/launch.sh
}

theme_i3() {
  if [[ ! $(grep "^set \$$THEME" ~/.i3/config) ]]; then
    local available=`awk "/# themed/,/# class/" ~/.i3/config | \
      egrep "set .[a-z]+.*" | awk -F' ' '{print $2}' | sed 's/\\$//'`
    no_theme_error "i3" "$available"
    return
  fi
  local current=`egrep -o "^client\.focused .*\$" ~/.i3/config \
    | awk -F' ' '{print $2}' | sed 's/\$//'`
  sed -i "/^client/s/${current}/\$${THEME}/g" ~/.i3/config
  i3-msg reload
}

theme_tmux() {
  if [[ ! $(grep "^${THEME}_" ~/.tmux.conf) ]]; then
    local available=`awk "/# Themed colors/,/\}\}\}/" ~/.tmux.conf | \
      grep ".*_status_active" | awk -F'_' '{print $1}'`
    no_theme_error "tmux" "$available"
    return
  fi
  local line=`grep -m 1 "=\$.*_" ~/.tmux.conf`
  local re='.*\$([a-z]+)_.*'
  [[ $line =~ $re ]]
  local current=${BASH_REMATCH[1]}
  sed -i "s/\$${current}_/\$${THEME}_/g" ~/dotfiles/tmux/.tmux.conf
}

theme_rofi() {
  if [ ! -r "/home/$USER/.config/rofi/colorschemes/$THEME.rasi" ]; then
    local available=`grep -r "@import \"general.rasi\"" ~/.config/rofi | \
      awk -F':' '{print $1}' | awk -F'.' '{print $2}' | awk -F'/' '{print $3}'`
    no_theme_error "rofi" "$available"
    return
  fi
  local line=`egrep -o "^@import .*\.rasi" ~/.config/rofi/launcher.rasi`
  local re='.*/([a-z]+).rasi'
  [[ $line =~ $re ]]
  local current=${BASH_REMATCH[1]}
  for f in $(grep -r $current ~/.config/rofi | cut -d':' -f 1); do
    sed -i "/^@import/s/${current}/${THEME}/g" $f
  done
}

theme_dunst() {
  # read the [urgency_normal] section and parse the background and foreground
  # colors based on either the theme or the default
  norm=`awk "/\[urgency_normal\]/,/\[urgency_critical/" \
    ~/.config/dunst/dunstrc | grep "$THEME:" || \
    awk "/\[urgency_normal\]/,/\[urgency_critical/" \
    ~/.config/dunst/dunstrc | grep "default:"`
  local norm_bg=$(echo $norm | awk -F'#' '{print $3}' | sed -e 's/[[:space:]]*$//')
  local norm_fg=$(echo $norm | awk -F'#' '{print $4}' | sed -e 's/[[:space:]]*$//')
  local nbeg=`grep -n "\[urgency_normal\]" ~/.config/dunst/dunstrc | \
    awk -F':' '{print $1}'`
  local nend=`grep -n "\[urgency_critical\]" ~/.config/dunst/dunstrc | \
    awk -F':' '{print $1}'`
  echo
  sed -ri "${nbeg},${nend}s/(^.*background = \"#)[a-f0-9]{6}/\1$norm_bg/" ~/.config/dunst/dunstrc
  sed -ri "${nbeg},${nend}s/(^.*foreground = \"#)[a-f0-9]{6}/\1$norm_fg/" ~/.config/dunst/dunstrc

  # read and parse the frame color based on either theme or default
  local frame=`echo $(awk "/color of the frame/,/color for the separator/" \
    ~/.config/dunst/dunstrc | grep "$THEME:" || \
    awk "/color of the frame/,/color for the separator/" \
    ~/.config/dunst/dunstrc | grep "default:") \
    | awk -F'#' '{print $3}' | sed -e 's/[[:space:]]*$//'`
  local fbeg=`grep -n "color of the frame" ~/.config/dunst/dunstrc | awk -F':' '{print $1}'`
  local fend=`grep -n "color for the separator" ~/.config/dunst/dunstrc | awk -F':' '{print $1}'`
  sed -ri "${fbeg},${fend}s/(^.*frame_color = \"#)[a-f0-9]{6}/\1$frame/" ~/.config/dunst/dunstrc

  # attempt to kill dunst to reload the config (shouldn't be allowed, since
  # daemon started from DBUS)
  pkill dunst
  if [[ "$norm" == *"default"* ]]; then
    warn "Reset dunst theme to default"
  fi
}

theme_ncmpcpp() {
  if [ ! -r "/home/$USER/.ncmpcpp/$THEME.ini" ]; then
    local available=`ls ~/.ncmpcpp/*.ini | \
      awk -F'/' '{print $5}' | awk -F'.' '{print $1}'`
    no_theme_error "ncmpcpp" "$available"
    return
  fi
  local music_dir=`grep music_directory ~/.config/mpd/mpd.conf | \
    awk -F'  ' '{print $2}'`
  sed "s~%music_dir%~$music_dir~" ~/.ncmpcpp/template > ~/.ncmpcpp/config
  IFS=$'\n'
  for line in $(cat ~/.ncmpcpp/$THEME.ini); do
    local param=`echo $line | awk -F'=' '{print $1}' | sed "s/ *$//g"`
    local value=`echo $line | awk -F'=' '{print $2}' | sed "s/^ *//g"`
    sed -i "s/%$param%/$value/g" ~/.ncmpcpp/config
  done
}

theme_vim() {
  if [[ ! $(grep "$THEME:" ~/.vimrc) ]]; then
    local available=`awk "/Split bar/,/}}}/" ~/.vimrc | \
      egrep "^\".*[a-z]+:.*[0-9]+" | awk -F':' '{print $1}' | sed 's/\" //'`
    no_theme_error "vim" "$available"
    return
  fi
  local themed=`grep "$THEME:" ~/.vimrc | awk -F': ' '{print $2}'`
  sed -ri "/VertSplit/s/(ctermfg=)[0-9]+/\1$themed/" ~/.vimrc
  sed -ri "/OverLength/s/(ctermbg=)[0-9]+/\1$themed/" ~/.vimrc
}

theme_others() {
  if [ -z $THEME ]; then
    bold=$(tput bold)
    error "" "${bold}No theme provided; exiting.${normal}"
    exit 1
  fi
  theme_i3
  theme_tmux
  theme_rofi
  theme_ncmpcpp
  theme_vim
  # TODO(zskendall): theme xfce4-terminal for light bg (paracosm)
}

if (( `ps -aux | grep polybar | wc -l` > 1 )) ; then
  notify-send -a recolor "changing theme to $THEME"
fi

if (( ${#IMAGES[@]} != `xrandr | egrep "[^dis]connected" | wc -l` )); then
  case $THEME in
    borealis)
      IMAGES=(~/dotfiles/images/background_main.jpg \
        ~/dotfiles/images/aurora_secondary.jpg)
      ;;
    nikhita)
      IMAGES=(~/dotfiles/images/background_secondary.jpg \
        ~/dotfiles/images/nikhita_secondary.jpg)
      ;;
    astral)
      IMAGES=(~/dotfiles/images/astral_main.jpg ~/dotfiles/images/DSC_4419.jpg)
      ;;
    autumnal)
      IMAGES=(~/dotfiles/images/autumnal_main.jpg \
        ~/dotfiles/images/autumnal_secondary.jpg)
      ;;
  esac
fi
refresh_display

theme_dunst
theme_polybar
theme_others
if (( `ps -aux | grep polybar | wc -l` > 1 )) ; then
  notify-send -a recolor "udpated theme to $THEME"
fi
